{"ts":1363211440287,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php\n/**\n * PHPInSimMod - Telnet Module\n * @package PRISM\n * @subpackage Telnet\n*/\n\nclass TSAdminSection extends TSSection\n{\n\tpublic function __construct(ScreenContainer $parentSection, $width, $height, $ttype = 0)\n\t{\n\t\tparent::__construct($parentSection);\n\t\t\n\t\t$this->setLocation(1, 3);\n\t\t$this->setSize($width, $height);\n\t\t$this->setTType($ttype);\n\t\t$this->setId('admins');\n//\t\t$this->setBorder(TS_BORDER_REGULAR);\n\n\t\t$this->createMenu();\n\t\t\n\t\t// Menu / content separator line\n//\t\t$vertLine = new TSVLine(18, 3, 20);\n//\t\t$vertLine->setTType($ttype);\n//\t\t$this->add($vertLine);\n\t}\n\t\n\tpublic function __destruct()\n\t{\n\t\tparent::__destruct();\n\t}\n\t\n\t// Toggle through 'add admin' and all t he existing admin accounts (and select)\n\tpublic function handleKey($key)\n\t{\n\t\tif ($this->subSection->getActive())\n\t\t{\n\t\t\tif ($this->subSection->handleKey($key))\n\t\t\t\treturn true;\n\t\t}\n\t\t\n\t\t$newItem = null;\n\t\t\n\t\tswitch($key)\n\t\t{\n\t\t\tcase KEY_CURUP :\n\t\t\t\t$newItem = $this->previousItem();\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tcase KEY_CURDOWN :\n\t\t\t\t$newItem = $this->nextItem();\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tcase KEY_CURRIGHT :\n\t\t\t\t$this->selectItem();\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tcase KEY_ESCAPE :\n\t\t\tcase KEY_CURLEFT :\n\t\t\t\t$this->deSelectItem();\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tdefault :\n\t\t\t\treturn false;\n\t\t}\n\t\t\n\t\t// Draw the new content screen\n\t\tif ($newItem !== null)\n\t\t{\n\t\t\t// Remove sub section from drawing list\n\t\t\tif ($this->subSection !== null)\n\t\t\t\t$this->remove($this->subSection);\n\t\t\t\n\t\t\t// Create new sub section - either to add or edit an admin\n\t\t\tif ($newItem->getId() == 'adminAdd')\n\t\t\t{\n\t\t\t\t$this->subSection = new TSAdminContentSection($this, TS_AACTION_ADD, 59, 21, '', $this->getTType());\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$this->subSection = new TSAdminContentSection($this, TS_AACTION_EDIT, 59, 21, $newItem->getText(), $this->getTType());\n\t\t\t}\n\t\t\t\n\t\t\t// Add sub section to drawing list\n\t\t\t$this->add($this->subSection);\n\t\t}\n\t\t\n\t\treturn true;\n\t}\n\t\n\tprivate function createMenu()\n\t{\n\t\tglobal $PRISM;\n\t\t\n\t\t$textArea = new TSTextArea(2, 4, 15, 1);\n\t\t$textArea->setId('adminAdd');\n\t\t$textArea->setText('Add admin');\n\t\t$textArea->setOptions(TS_OPT_ISSELECTABLE | TS_OPT_ISSELECTED);\n\t\t$this->add($textArea);\n\n\t\t// Create list of selectable usernames\n\t\t$admins = $PRISM->admins->getAdminsInfo();\n\t\t\n\t\t$line = 5;\n\t\tforeach ($admins as $username => $details)\n\t\t{\n\t\t\t$textArea = new TSTextArea(2, $line, 15, 1);\n\t\t\t$textArea->setId('a'.($line - 5));\n\t\t\t$textArea->setText($username);\n\t\t\t$textArea->setOptions(TS_OPT_ISSELECTABLE);\n\t\t\t$this->add($textArea);\n\t\t\t\n\t\t\t$line++;\n\t\t}\n\n\t\t$this->subSection = new TSAdminContentSection($this, TS_AACTION_ADD, 59, 21, '', $this->getTType());\n\t\t$this->add($this->subSection);\n\t}\n\t\n\tpublic function redrawMenu()\n\t{\n\t\t$this->removeAll();\n\t\t$this->resetSection();\n\t\t$this->createMenu();\n\t}\n\t\n\tprotected function selectItem()\n\t{\n//\t\tconsole('Selecting item '.$this->subSection->getId().' ('.$this->subSection->getUsername().')');\n\t\t\n\t\t// Change focus (set actives)\n\t\t$this->setActive(false);\n\t\t$this->getCurObject()->setBold(true);\n\t\t$this->subSection->setActive(true);\n\t}\n\t\n\tprotected function deSelectItem()\n\t{\n\t\t// Change focus (set actives)\n\t\tif ($this->getActive() == true)\n\t\t\treturn;\n\t\t\n//\t\tconsole('Selecting item '.$this->subSection->getId().' ('.$this->subSection->getUsername().')');\n\t\t\n\t\t$this->setActive(true);\n\t\t$this->getCurObject()->setBold(false);\n\t\t$this->subSection->setActive(false);\n\t}\n\n\tprotected function setInputMode()\n\t{\n\t\t$object = $this->getCurObject();\n\t\tswitch ($object->getId())\n\t\t{\n\t\t\tdefault :\n\t\t\t\t$this->setInputCallback(null);\n\t\t\t\tbreak;\n\t\t}\n\t}\n}\n\ndefine('TS_AACTION_ADD', 0);\ndefine('TS_AACTION_EDIT', 1);\n\nclass TSAdminContentSection extends TSSection\n{\n\tprivate $actionType\t\t= 0;\n\tprivate $username\t\t= '';\n\tprivate $userDetails\t= array();\n\t\n\tpublic function __construct(ScreenContainer $parentSection, $actionType, $width, $height, $username, $ttype = 0)\n\t{\n\t\tparent::__construct($parentSection);\n\t\t\n\t\t$this->actionType = $actionType;\n\t\t$this->setLocation(20, 3);\n\t\t$this->setSize($width, $height);\n\t\t$this->setTType($ttype);\n\t\t$this->setId('adminsContent');\n\t\t$this->setBorder(TS_BORDER_REGULAR);\n\t\t\n\t\tif ($username)\n\t\t{\n\t\t\t$this->setUsername($username);\n\t\t\t$this->setCaption('Edit admin '.$this->username);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$this->setCaption('Add new administrator');\n\t\t}\n\n\t\t$this->createAdminContent();\n\t}\n\t\n\tpublic function __destruct()\n\t{\n\t\tparent::__destruct();\n\t}\n\t\n\tpublic function handleKey($key)\n\t{\n\t\tswitch ($key)\n\t\t{\n\t\t\tcase KEY_SHIFTTAB :\n\t\t\tcase KEY_CURUP :\n\t\t\t\t$newItem = $this->previousItem();\n\t\t\t\t$this->setInputMode();\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tcase KEY_TAB :\n\t\t\tcase KEY_CURDOWN :\n\t\t\t\t$newItem = $this->nextItem();\n\t\t\t\t$this->setInputMode();\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tcase KEY_CURRIGHT :\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tcase KEY_ENTER :\n\t\t\t\tswitch ($this->getCurObject()->getId())\n\t\t\t\t{\n\t\t\t\t\tcase 'adminSave' :\n\t\t\t\t\t\t$this->adminSave();\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t\n\t\t\t\t\tcase 'adminDelete' :\n\t\t\t\t\t\t$this->adminDelete();\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tdefault :\n\t\t\t\treturn false;\n\t\t}\n\t\t\n\t\treturn true;\n\t}\n\n\tprotected function setInputMode()\n\t{\n\t\t$object = $this->getCurObject();\n\t\tswitch ($object->getId())\n\t\t{\n\t\t\tcase 'adminUsername' :\n\t\t\t\t$this->setInputCallback(\n\t\t\t\t\t$this, \n\t\t\t\t\t'handleAdminInput', \n\t\t\t\t\tTELNET_MODE_LINEEDIT, \n\t\t\t\t\tarray(31 + strlen($object->getText()), 6), \n\t\t\t\t\t$object->getText(), \n\t\t\t\t\t23\n\t\t\t\t);\n//\t\t\t\tconsole('Setting username line edit callback');\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tcase 'adminPassword' :\n\t\t\t\tif ($this->actionType == TS_AACTION_ADD)\n\t\t\t\t{\n\t\t\t\t\t$this->setInputCallback(\n\t\t\t\t\t\t$this, \n\t\t\t\t\t\t'handleAdminInput', \n\t\t\t\t\t\tTELNET_MODE_LINEEDIT, \n\t\t\t\t\t\tarray(31 + strlen($object->getText()), 10), \n\t\t\t\t\t\t$object->getText(), \n\t\t\t\t\t\t24\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$this->setInputCallback(\n\t\t\t\t\t\t$this, \n\t\t\t\t\t\t'handleAdminInput', \n\t\t\t\t\t\tTELNET_MODE_LINEEDIT, \n\t\t\t\t\t\tarray(31 + strlen($object->getText()), 6), \n\t\t\t\t\t\t$object->getText(), \n\t\t\t\t\t\t24\n\t\t\t\t\t);\n\t\t\t\t}\n//\t\t\t\tconsole('Setting password line edit callback');\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tcase 'adminFlags' :\n\t\t\t\tif ($this->actionType == TS_AACTION_ADD)\n\t\t\t\t{\n\t\t\t\t\t$this->setInputCallback(\n\t\t\t\t\t\t$this, \n\t\t\t\t\t\t'handleAdminInput', \n\t\t\t\t\t\tTELNET_MODE_LINEEDIT, \n\t\t\t\t\t\tarray(31 + strlen($object->getText()), 14), \n\t\t\t\t\t\t$object->getText(), \n\t\t\t\t\t\t26\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$this->setInputCallback(\n\t\t\t\t\t\t$this, \n\t\t\t\t\t\t'handleAdminInput', \n\t\t\t\t\t\tTELNET_MODE_LINEEDIT, \n\t\t\t\t\t\tarray(31 + strlen($object->getText()), 10), \n\t\t\t\t\t\t$object->getText(), \n\t\t\t\t\t\t26\n\t\t\t\t\t);\n\t\t\t\t}\n//\t\t\t\tconsole('Setting flags line edit callback');\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tdefault :\n\t\t\t\t$this->setInputCallback(null);\n//\t\t\t\tconsole('Setting key edit callback');\n\t\t\t\tbreak;\n\t\t}\n\t\t\n\t}\n\t\n\tprotected function selectItem()\n\t{\n\t\t\n\t}\n\t\n\tprivate function createAdminContent()\n\t{\n\t\tif ($this->actionType == TS_AACTION_ADD)\n\t\t{\n\t\t\t// New username\n\t\t\t$textArea = new TSTextInput(30, 5, 30, 3);\n\t\t\t$textArea->setId('adminUsername');\n\t\t\t$textArea->setTType($this->getTType());\n\t\t\t$textArea->setMaxLength(23);\n\t\t\t$textArea->setText('');\n\t\t\t$textArea->setOptions(TS_OPT_ISSELECTABLE | TS_OPT_ISEDITABLE);\n\t\t\t$textArea->setBorder(TS_BORDER_REGULAR);\n\t\t\t$textArea->setCaption('LFS Username (exact match)');\n\t\t\t$this->add($textArea);\n\n\t\t\t// New password\n\t\t\t$textArea = new TSTextInput(30, 9, 30, 3);\n\t\t\t$textArea->setId('adminPassword');\n\t\t\t$textArea->setTType($this->getTType());\n\t\t\t$textArea->setMaxLength(23);\n\t\t\t$textArea->setText('');\n\t\t\t$textArea->setOptions(TS_OPT_ISSELECTABLE | TS_OPT_ISEDITABLE);\n\t\t\t$textArea->setBorder(TS_BORDER_REGULAR);\n\t\t\t$textArea->setCaption('Prism Password');\n\t\t\t$this->add($textArea);\n\n\t\t\t// Admin flags\n\t\t\t$textArea = new TSTextInput(30, 13, 30, 3);\n\t\t\t$textArea->setId('adminFlags');\n\t\t\t$textArea->setTType($this->getTType());\n\t\t\t$textArea->setMaxLength(26);\n\t\t\t$textArea->setText('abcdetc');\n\t\t\t$textArea->setOptions(TS_OPT_ISSELECTABLE | TS_OPT_ISEDITABLE);\n\t\t\t$textArea->setBorder(TS_BORDER_REGULAR);\n\t\t\t$textArea->setCaption('Permission flags');\n\t\t\t$this->add($textArea);\n\t\t\t\n\t\t\t// Save\n\t\t\t$textArea = new TSTextArea(30, 17, 12, 3);\n\t\t\t$textArea->setId('adminSave');\n\t\t\t$textArea->setTType($this->getTType());\n\t\t\t$textArea->setText('Save admin');\n\t\t\t$textArea->setOptions(TS_OPT_ISSELECTABLE);\n\t\t\t$textArea->setBorder(TS_BORDER_REGULAR);\n\t\t\t$this->add($textArea);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// New password\n\t\t\t$textArea = new TSTextInput(30, 5, 30, 3);\n\t\t\t$textArea->setId('adminPassword');\n\t\t\t$textArea->setTType($this->getTType());\n\t\t\t$textArea->setText('');\n\t\t\t$textArea->setOptions(TS_OPT_ISSELECTABLE | TS_OPT_ISEDITABLE);\n\t\t\t$textArea->setBorder(TS_BORDER_REGULAR);\n\t\t\t$textArea->setCaption('Prism Password');\n\t\t\t$this->add($textArea);\n\n\t\t\t// Admin flags\n\t\t\t$textArea = new TSTextInput(30, 9, 30, 3);\n\t\t\t$textArea->setId('adminFlags');\n\t\t\t$textArea->setTType($this->getTType());\n\t\t\t$textArea->setText(flagsToString($this->userDetails['accessFlags']));\n\t\t\t$textArea->setOptions(TS_OPT_ISSELECTABLE | TS_OPT_ISEDITABLE);\n\t\t\t$textArea->setBorder(TS_BORDER_REGULAR);\n\t\t\t$textArea->setCaption('Permission flags');\n\t\t\t$this->add($textArea);\n\t\t\t\n\t\t\t// Save\n\t\t\t$textArea = new TSTextArea(30, 13, 12, 3);\n\t\t\t$textArea->setId('adminSave');\n\t\t\t$textArea->setTType($this->getTType());\n\t\t\t$textArea->setText('Save admin');\n\t\t\t$textArea->setOptions(TS_OPT_ISSELECTABLE);\n\t\t\t$textArea->setBorder(TS_BORDER_REGULAR);\n\t\t\t$this->add($textArea);\n\n\t\t\t// Delete\n\t\t\t$textArea = new TSTextArea(30, 17, 14, 3);\n\t\t\t$textArea->setId('adminDelete');\n\t\t\t$textArea->setTType($this->getTType());\n\t\t\t$textArea->setText('Delete admin');\n\t\t\t$textArea->setOptions(TS_OPT_ISSELECTABLE);\n\t\t\t$textArea->setBorder(TS_BORDER_REGULAR);\n\t\t\t$this->add($textArea);\n\t\t}\n\t\t\n\t}\n\t\n\tpublic function setUsername($username)\n\t{\n\t\tglobal $PRISM;\n\t\t\n\t\t$this->username = $username;\n\t\t$this->userDetails = $PRISM->admins->getAdminInfo($username);\n\t}\n\t\n\tpublic function getUsername()\n\t{\n\t\treturn $this->username;\n\t}\n\t\n\tprivate function adminSave()\n\t{\n\t\tglobal $PRISM;\n\t\t// Collect data from input fields\n\t\t$username\t= ($this->actionType == TS_AACTION_ADD) ? $this->getObjectById('adminUsername')->getText() : $this->username;\n\t\t$password\t= $this->getObjectById('adminPassword')->getText();\n\t\t$flags\t\t= $this->getObjectById('adminFlags')->getText();\n\t\t\n\t\t// Save admin\n\t\tif ($PRISM->admins->adminExists($username))\n\t\t{\n\t\t\t// Update admin\n\t\t\tif ($password != '')\n\t\t\t\t$PRISM->admins->changePassword($username, $password);\n\t\t\t$PRISM->admins->setAccessFlags($username, flagsToInteger($flags));\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// New admin\n\t\t\tif ($username == '' || $password == '')\n\t\t\t\treturn;\n\t\t\t$PRISM->admins->addAccount($username, $password, flagsToInteger($flags));\n\t\t\t$PRISM->admins->setAccessFlags($username, flagsToInteger($flags));\n\t\t}\n\t\t\n\t\t$this->parentSection->redrawMenu();\n\t\t\n//\t\tconsole('Save this admin '.$username.' / '.$password.' / '.$flags);\n\t}\n\t\n\tprivate function adminDelete()\n\t{\n\t\tglobal $PRISM;\n\t\t\n\t\tif ($this->username)\n\t\t\t$PRISM->admins->deleteAccount($this->username);\n\t\t\n\t\t$this->parentSection->redrawMenu();\n\n//\t\tconsole('Delete this admin '.$this->username);\n\t}\n\t\n\tpublic function handleAdminInput($line)\n\t{\n\t\t$this->getCurObject()->setText($line);\n\t\t$this->setInputMode();\n//\t\tconsole('handleAdminInput ('.$this->getCurObject()->getId().') received a line : '.$line);\n\t}\n}\n\n?>"]],"start1":0,"start2":0,"length1":0,"length2":11175}]],"length":11175}
